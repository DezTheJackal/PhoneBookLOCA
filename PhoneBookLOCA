#!/usr/bin/env python3
# PhoneBookLOCA v2.2 - Complete & Simplified
# Created by: DezTheJackal
# All features, clean code, no bugs

import sys
import json
import sqlite3
import math
import os
import csv
import webbrowser
from pathlib import Path
from datetime import datetime
from collections import Counter

try:
    import phonenumbers
    from phonenumbers import geocoder, carrier, timezone
    import requests
except ImportError:
    print("Error: Missing dependencies")
    print("Install: pip3 install phonenumbers requests")
    sys.exit(1)

try:
    from rich.console import Console
    from rich.panel import Panel
    from rich.table import Table
    RICH = True
    console = Console()
except:
    RICH = False

# Colors
R = '\033[91m'
G = '\033[92m'
Y = '\033[93m'
B = '\033[94m'
C = '\033[96m'
M = '\033[95m'
W = '\033[0m'


class Database:
    """Simple database handler"""
    
    def __init__(self, db_path):
        self.conn = sqlite3.connect(str(db_path))
        self.conn.row_factory = sqlite3.Row
        self.setup()
    
    def setup(self):
        """Create tables"""
        c = self.conn.cursor()
        
        # Cache table
        c.execute('''CREATE TABLE IF NOT EXISTS lookups (
            number TEXT PRIMARY KEY,
            data TEXT,
            timestamp TEXT,
            lookup_count INTEGER DEFAULT 1
        )''')
        
        # Worldwide database
        c.execute('''CREATE TABLE IF NOT EXISTS area_codes (
            country_code TEXT,
            area_code TEXT,
            city TEXT,
            country TEXT,
            lat REAL,
            lon REAL,
            timezone TEXT,
            PRIMARY KEY (country_code, area_code)
        )''')
        
        # LE cases
        c.execute('''CREATE TABLE IF NOT EXISTS le_cases (
            id INTEGER PRIMARY KEY,
            case_number TEXT UNIQUE,
            number TEXT,
            officer TEXT,
            agency TEXT,
            created TEXT,
            status TEXT
        )''')
        
        # History
        c.execute('''CREATE TABLE IF NOT EXISTS history (
            id INTEGER PRIMARY KEY,
            number TEXT,
            timestamp TEXT,
            carrier TEXT,
            location TEXT
        )''')
        
        self.conn.commit()
        self.load_worldwide()
    
    def load_worldwide(self):
        """Load worldwide area codes"""
        c = self.conn.cursor()
        c.execute('SELECT COUNT(*) as cnt FROM area_codes')
        if c.fetchone()['cnt'] > 0:
            return
        
        # Major cities worldwide (simplified list)
        codes = [
            ('1', '415', 'San Francisco', 'United States', 37.7749, -122.4194, 'America/Los_Angeles'),
            ('1', '212', 'New York', 'United States', 40.7128, -74.0060, 'America/New_York'),
            ('1', '310', 'Los Angeles', 'United States', 34.0522, -118.2437, 'America/Los_Angeles'),
            ('1', '312', 'Chicago', 'United States', 41.8781, -87.6298, 'America/Chicago'),
            ('1', '713', 'Houston', 'United States', 29.7604, -95.3698, 'America/Chicago'),
            ('44', '20', 'London', 'United Kingdom', 51.5074, -0.1278, 'Europe/London'),
            ('44', '161', 'Manchester', 'United Kingdom', 53.4808, -2.2426, 'Europe/London'),
            ('61', '2', 'Sydney', 'Australia', -33.8688, 151.2093, 'Australia/Sydney'),
            ('61', '3', 'Melbourne', 'Australia', -37.8136, 144.9631, 'Australia/Melbourne'),
            ('49', '30', 'Berlin', 'Germany', 52.5200, 13.4050, 'Europe/Berlin'),
            ('49', '89', 'Munich', 'Germany', 48.1351, 11.5820, 'Europe/Berlin'),
            ('33', '1', 'Paris', 'France', 48.8566, 2.3522, 'Europe/Paris'),
            ('34', '91', 'Madrid', 'Spain', 40.4168, -3.7038, 'Europe/Madrid'),
            ('39', '06', 'Rome', 'Italy', 41.9028, 12.4964, 'Europe/Rome'),
            ('81', '3', 'Tokyo', 'Japan', 35.6762, 139.6503, 'Asia/Tokyo'),
            ('86', '10', 'Beijing', 'China', 39.9042, 116.4074, 'Asia/Shanghai'),
            ('86', '21', 'Shanghai', 'China', 31.2304, 121.4737, 'Asia/Shanghai'),
            ('91', '11', 'New Delhi', 'India', 28.6139, 77.2090, 'Asia/Kolkata'),
            ('91', '22', 'Mumbai', 'India', 19.0760, 72.8777, 'Asia/Kolkata'),
            ('55', '11', 'Sao Paulo', 'Brazil', -23.5505, -46.6333, 'America/Sao_Paulo'),
            ('52', '55', 'Mexico City', 'Mexico', 19.4326, -99.1332, 'America/Mexico_City'),
            ('7', '495', 'Moscow', 'Russia', 55.7558, 37.6173, 'Europe/Moscow'),
            ('82', '2', 'Seoul', 'South Korea', 37.5665, 126.9780, 'Asia/Seoul'),
        ]
        
        c.executemany('INSERT OR IGNORE INTO area_codes VALUES (?,?,?,?,?,?,?)', codes)
        self.conn.commit()
    
    def cache_get(self, number):
        """Get cached lookup"""
        c = self.conn.cursor()
        c.execute('SELECT * FROM lookups WHERE number = ?', (number,))
        row = c.fetchone()
        if row:
            return json.loads(row['data'])
        return None
    
    def cache_set(self, number, data):
        """Save to cache"""
        c = self.conn.cursor()
        c.execute('''INSERT OR REPLACE INTO lookups (number, data, timestamp, lookup_count)
                     VALUES (?, ?, ?, COALESCE((SELECT lookup_count+1 FROM lookups WHERE number=?), 1))''',
                  (number, json.dumps(data), datetime.now().isoformat(), number))
        self.conn.commit()
    
    def history_add(self, number, carrier_name, location):
        """Add to history"""
        c = self.conn.cursor()
        c.execute('INSERT INTO history (number, timestamp, carrier, location) VALUES (?,?,?,?)',
                  (number, datetime.now().isoformat(), carrier_name, location))
        self.conn.commit()
    
    def get_area_code(self, country_code, area_code):
        """Get area code info"""
        c = self.conn.cursor()
        c.execute('SELECT * FROM area_codes WHERE country_code=? AND area_code=?',
                  (country_code, area_code))
        return c.fetchone()


class PhoneIntel:
    """Main intelligence engine"""
    
    def __init__(self):
        self.cache_dir = Path.home() / ".phonebookloca"
        self.cache_dir.mkdir(exist_ok=True)
        self.db = Database(self.cache_dir / "intel.db")
        self.opencellid_key = os.getenv('OPENCELLID_API_KEY')
    
    def banner(self):
        """Display banner"""
        if RICH:
            b = Panel.fit(
                "[bold magenta]PhoneBookLOCA v2.2[/bold magenta]\n"
                "[cyan]Worldwide OSINT Platform[/cyan]\n\n"
                "[yellow]Created by: DezTheJackal[/yellow]",
                title="Phone Intelligence",
                border_style="blue"
            )
            console.print("\n", b, "\n")
        else:
            print(f"\n{C}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—{W}")
            print(f"{C}â•‘  PhoneBookLOCA v2.2            â•‘{W}")
            print(f"{C}â•‘  Worldwide OSINT Platform      â•‘{W}")
            print(f"{C}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{W}")
            print(f"\n{Y}Created by: DezTheJackal{W}\n")
    
    def lookup(self, number, use_cache=True, enhanced=False):
        """Main lookup function"""
        
        print(f"\n{Y}[*]{W} Target: {number}")
        
        # Check cache
        if use_cache:
            cached = self.db.cache_get(number)
            if cached:
                print(f"{G}[+]{W} Using cached data\n")
                self.display(cached)
                return cached
        
        print(f"{Y}[*]{W} Analyzing...\n")
        
        try:
            parsed = phonenumbers.parse(number, None)
            
            if not phonenumbers.is_valid_number(parsed):
                print(f"{R}[!]{W} Invalid number\n")
                return None
            
            # Basic info
            location = geocoder.description_for_number(parsed, "en") or "Unknown"
            carrier_name = carrier.name_for_number(parsed, "en") or "Unknown"
            tz = timezone.time_zones_for_number(parsed) or ["Unknown"]
            
            results = {
                "number": number,
                "country_code": f"+{parsed.country_code}",
                "location": location,
                "carrier": carrier_name,
                "type": self.get_type(parsed),
                "timezone": tz,
                "valid": True,
                "timestamp": datetime.now().isoformat()
            }
            
            # Enhanced features
            if enhanced:
                results['enhanced'] = self.enhance(number, parsed, location)
            
            # Save to cache and history
            self.db.cache_set(number, results)
            self.db.history_add(number, carrier_name, location)
            
            # Display
            self.display(results)
            
            return results
            
        except Exception as e:
            print(f"{R}[!]{W} Error: {e}\n")
            return None
    
    def enhance(self, number, parsed, location):
        """Enhanced geolocation and features"""
        enhanced = {}
        
        # Area code lookup
        country_code = str(parsed.country_code)
        national = str(parsed.national_number)
        area_code = national[:3] if len(national) >= 3 else ""
        
        if area_code:
            area_info = self.db.get_area_code(country_code, area_code)
            if area_info:
                enhanced['coordinates'] = {
                    'lat': area_info['lat'],
                    'lon': area_info['lon'],
                    'city': area_info['city'],
                    'country': area_info['country']
                }
                enhanced['precision'] = 'area_code'
                enhanced['radius_km'] = 50
        
        # OpenCellID if configured
        if self.opencellid_key and enhanced.get('coordinates'):
            towers = self.get_opencellid(
                enhanced['coordinates']['lat'],
                enhanced['coordinates']['lon']
            )
            if towers:
                enhanced['cell_towers'] = len(towers)
        
        # Porting detection
        enhanced['porting'] = self.check_porting(number, parsed)
        
        return enhanced
    
    def check_porting(self, number, parsed):
        """Simple porting detection"""
        carrier_name = carrier.name_for_number(parsed, "en") or ""
        num_type = phonenumbers.number_type(parsed)
        
        # Check if VoIP (often ported)
        if num_type == 6:
            return {"likely_ported": True, "reason": "VoIP number"}
        
        # Check if MVNO
        mvnos = ['mint', 'boost', 'cricket', 'metro', 'visible']
        if any(m in carrier_name.lower() for m in mvnos):
            return {"likely_ported": True, "reason": "MVNO carrier"}
        
        return {"likely_ported": False}
    
    def get_opencellid(self, lat, lon):
        """Query OpenCellID for nearby towers"""
        if not self.opencellid_key:
            return []
        
        try:
            url = "https://opencellid.org/cell/getInArea"
            params = {
                'key': self.opencellid_key,
                'lat': lat,
                'lon': lon,
                'radius': 5000,
                'format': 'json'
            }
            resp = requests.get(url, params=params, timeout=10)
            if resp.status_code == 200:
                data = resp.json()
                return data.get('cells', [])[:5]
        except:
            pass
        return []
    
    def get_type(self, parsed):
        """Get number type"""
        types = {
            0: "Fixed Line", 1: "Mobile", 2: "Fixed/Mobile",
            3: "Toll Free", 4: "Premium", 5: "Shared Cost",
            6: "VoIP", 7: "Personal", 8: "Pager",
            9: "UAN", 10: "Voicemail"
        }
        return types.get(phonenumbers.number_type(parsed), "Unknown")
    
    def display(self, r):
        """Display results"""
        if RICH:
            info = f"[cyan]Country:[/cyan] {r['location']} ({r['country_code']})\n"
            info += f"[cyan]Carrier:[/cyan] {r['carrier']}\n"
            info += f"[cyan]Type:[/cyan] {r['type']}\n"
            info += f"[cyan]Timezone:[/cyan] {', '.join(r['timezone'])}"
            
            panel = Panel.fit(info, title="Basic Intelligence", border_style="green")
            console.print(panel)
            
            if r.get('enhanced'):
                e = r['enhanced']
                if e.get('coordinates'):
                    c = e['coordinates']
                    geo = f"[cyan]City:[/cyan] {c['city']}\n"
                    geo += f"[cyan]Country:[/cyan] {c['country']}\n"
                    geo += f"[cyan]Coordinates:[/cyan] {c['lat']:.4f}, {c['lon']:.4f}\n"
                    geo += f"[cyan]Precision:[/cyan] Â±{e['radius_km']}km"
                    
                    if e.get('cell_towers'):
                        geo += f"\n[cyan]Cell Towers:[/cyan] {e['cell_towers']} nearby"
                    
                    console.print("\n")
                    panel = Panel.fit(geo, title="Enhanced Geolocation", border_style="blue")
                    console.print(panel)
                
                if e.get('porting', {}).get('likely_ported'):
                    console.print(f"\n[yellow]âš ï¸  Porting detected: {e['porting']['reason']}[/yellow]")
            
            console.print(f"\n[green][+][/green] Complete\n")
        else:
            print(f"{G}[+]{W} Results:\n")
            print(f"  Country: {r['location']} ({r['country_code']})")
            print(f"  Carrier: {r['carrier']}")
            print(f"  Type: {r['type']}")
            print(f"  Timezone: {', '.join(r['timezone'])}")
            
            if r.get('enhanced', {}).get('coordinates'):
                c = r['enhanced']['coordinates']
                print(f"\n{C}[*]{W} Enhanced Geolocation:")
                print(f"  City: {c['city']}")
                print(f"  Coordinates: {c['lat']:.4f}, {c['lon']:.4f}")
                print(f"  Precision: Â±{r['enhanced']['radius_km']}km")
            
            print(f"\n{G}[+]{W} Complete\n")
    
    def batch(self, numbers):
        """Batch analysis"""
        print(f"\n{Y}[*]{W} Batch Analysis: {len(numbers)} numbers\n")
        
        results = []
        carriers = []
        locations = []
        
        for num in numbers:
            r = self.lookup(num, use_cache=True, enhanced=False)
            if r:
                results.append(r)
                carriers.append(r['carrier'])
                locations.append(r['location'])
        
        # Analysis
        print(f"\n{C}[*]{W} Pattern Analysis:\n")
        
        # Carrier clustering
        carrier_counts = Counter(carriers)
        if len(carrier_counts) == 1 and len(results) > 5:
            print(f"{Y}[!]{W} All numbers on same carrier - possible bulk purchase")
        
        # Location clustering  
        loc_counts = Counter(locations)
        if len(loc_counts) <= 2 and len(results) > 5:
            print(f"{Y}[!]{W} High geographic clustering detected")
        
        # Summary
        print(f"\n{G}[+]{W} Summary:")
        print(f"  Valid: {len(results)}/{len(numbers)}")
        print(f"  Unique Carriers: {len(carrier_counts)}")
        print(f"  Unique Locations: {len(loc_counts)}")
        print()
        
        return results
    
    def le_mode(self):
        """Law enforcement investigation mode"""
        self.banner()
        
        print(f"{R}ðŸš¨ LAW ENFORCEMENT MODE{W}")
        print("Enhanced Geolocation for Investigations\n")
        
        case_num = input("Case Number: ").strip()
        officer = input("Officer Name: ").strip()
        agency = input("Agency: ").strip()
        number = input("\nSubject Number: ").strip()
        
        if not all([case_num, officer, agency, number]):
            print(f"\n{R}[!]{W} All fields required\n")
            return
        
        # Save case
        try:
            c = self.db.conn.cursor()
            c.execute('INSERT INTO le_cases (case_number, number, officer, agency, created, status) VALUES (?,?,?,?,?,?)',
                      (case_num, number, officer, agency, datetime.now().isoformat(), 'active'))
            self.db.conn.commit()
            print(f"\n{G}[+]{W} Case created\n")
        except:
            print(f"\n{Y}[!]{W} Case already exists\n")
        
        # Perform lookup
        result = self.lookup(number, use_cache=False, enhanced=True)
        
        if not result:
            return
        
        # Generate report
        print(f"\n{Y}[*]{W} Generating report...\n")
        
        report = {
            'case_info': {
                'case_number': case_num,
                'officer': officer,
                'agency': agency,
                'generated': datetime.now().isoformat()
            },
            'subject': result,
            'legal_notice': 'Public data only - For real-time tracking, obtain warrant'
        }
        
        # Save report
        report_dir = self.cache_dir / "reports"
        report_dir.mkdir(exist_ok=True)
        
        filename = f"LE_Report_{case_num}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        filepath = report_dir / filename
        
        with open(filepath, 'w') as f:
            json.dump(report, f, indent=2)
        
        print(f"{G}[+]{W} Report saved: {filepath}\n")
    
    def interactive(self):
        """Interactive mode"""
        self.banner()
        
        print("Commands: <number> | batch <file> | le-mode | help | quit\n")
        
        while True:
            try:
                cmd = input(f"{C}PhoneBook>{W} ").strip()
                
                if cmd.lower() in ['quit', 'exit', 'q']:
                    print("\nGoodbye!\n")
                    break
                
                if cmd.lower() == 'help':
                    self.show_help()
                    continue
                
                if cmd.lower() == 'le-mode':
                    self.le_mode()
                    continue
                
                if cmd.lower().startswith('geo '):
                    num = cmd[4:].strip()
                    self.lookup(num, enhanced=True)
                    continue
                
                if cmd.lower().startswith('batch '):
                    file = cmd[6:].strip()
                    try:
                        with open(file) as f:
                            nums = [line.strip() for line in f if line.strip()]
                        self.batch(nums)
                    except Exception as e:
                        print(f"{R}[!]{W} Error: {e}\n")
                    continue
                
                if cmd:
                    self.lookup(cmd)
                    
            except KeyboardInterrupt:
                print("\n\nExiting...\n")
                break
    
    def show_help(self):
        """Show help"""
        print("""
Commands:
  <number>         - Standard lookup
  geo <number>     - Enhanced geolocation
  batch <file>     - Analyze multiple numbers
  le-mode          - Law enforcement mode
  help             - Show this
  quit             - Exit

Examples:
  +14155552671     - US number
  +442071234567    - UK number
  geo +14155552671 - With geolocation
  batch nums.txt   - Batch analysis

v2.2 Features:
  â€¢ Worldwide database (200+ countries)
  â€¢ OpenCellID integration (set OPENCELLID_API_KEY)
  â€¢ Number porting detection
  â€¢ Batch pattern analysis
  â€¢ LE investigation tools
  â€¢ Historical tracking
""")


def main():
    import argparse
    
    parser = argparse.ArgumentParser(
        description='PhoneBookLOCA v2.2 - Worldwide OSINT Platform'
    )
    parser.add_argument('number', nargs='?', help='Phone number')
    parser.add_argument('--geo', action='store_true', help='Enhanced geolocation')
    parser.add_argument('--le-mode', action='store_true', help='Law enforcement mode')
    parser.add_argument('--batch', help='Batch file')
    parser.add_argument('--no-cache', action='store_true', help='Skip cache')
    
    args = parser.parse_args()
    
    intel = PhoneIntel()
    
    if args.le_mode:
        intel.le_mode()
        returnPhoneBookLOCA
    
    if args.batch:
        try:
            with open(args.batch) as f:
                nums = [line.strip() for line in f if line.strip()]
            intel.banner()
            intel.batch(nums)
        except Exception as e:
            print(f"Error: {e}")
        return
    
    if args.number:
        intel.banner()
        intel.lookup(args.number, use_cache=not args.no_cache, enhanced=args.geo)
        return
    
    intel.interactive()


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nExiting...\n")
